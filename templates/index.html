<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CodePlz - AI-Powered Code Editing</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            body {
                background-color: #f0f2f5;
            }

            .container {
                max-width: 800px;
            }

            .card {
                border: none;
                border-radius: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
            }

            .card-header {
                background-color: #fff;
                border-bottom: 1px solid #e0e0e0;
                padding: 15px 20px;
            }

            .card-body {
                padding: 20px;
            }

            .btn {
                border-radius: 5px;
            }

            .file-item {
                border-left: none;
            }

            .file-item:hover {
                box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            }

            .diff-view {
                font-family: monospace;
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow-x: auto;
                background-color: #f8f9fa;
                border: none;
                border-radius: 5px;
                padding: 1rem;
                margin-top: 1rem;
            }

            .diff-added,
            .diff-removed,
            .diff-context {
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            .diff-added {
                background-color: #e6ffec;
                color: #24292e;
            }

            .diff-removed {
                background-color: #ffebe9;
                color: #24292e;
            }

            .diff-context {
                color: #6a737d;
                background-color: #f6f8fa;
            }

            .file-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .token-count {
                font-size: 0.9rem;
                color: #6c757d;
                margin-top: 0.5rem;
            }

            .server-path {
                font-size: 1rem;
                color: #6c757d;
                margin-top: -1rem;
                margin-bottom: 2rem;
            }

            #userRequest {
                resize: vertical;
                min-height: 120px;
                border: 1px solid #ced4da;
                border-radius: 0.25rem;
                transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
                width: 100%;
                padding: 0.75rem;
                font-size: 1rem;
                line-height: 1.5;
            }

            #userRequest:focus {
                border-color: #86b7fe;
                outline: 0;
                box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            }

            #submitRequest {
                margin-top: 1rem;
            }

            @media (max-width: 767.98px) {
                #submitRequest {
                    width: 100%;
                }
            }

            .action-buttons {
                display: flex;
                justify-content: space-between;
                margin-top: 1rem;
            }

            .dark-mode {
                background-color: #1a1a1a;
            }

            .dark-mode .card {
                background-color: #2c2c2c;
                box-shadow: 0 4px 6px rgba(255, 255, 255, 0.1);
            }

            .dark-mode .card-header {
                background-color: #2c2c2c;
                border-bottom: 1px solid #3a3a3a;
            }

            .dark-mode .diff-view {
                background-color: #333;
            }

            .dark-mode .diff-added {
                background-color: #1b4721;
                color: #e6ffec;
            }

            .dark-mode .diff-removed {
                background-color: #5c1b1b;
                color: #ffebe9;
            }

            .dark-mode .diff-context {
                color: #8b949e;
                background-color: #2d333b;
            }

            .dark-mode .btn-primary {
                background-color: #4dabf7;
                border-color: #4dabf7;
                color: #212529;
            }

            .dark-mode .btn-primary:hover {
                background-color: #3793dd;
                border-color: #3793dd;
                color: #212529;
            }

            .dark-mode .btn-primary:focus {
                box-shadow: 0 0 0 0.25rem rgba(77, 171, 247, 0.5);
            }

            .dark-mode .card-header.bg-primary {
                background-color: #4dabf7 !important;
                color: #212529;
            }

            #darkModeToggle {
                position: fixed;
                top: 1rem;
                right: 1rem;
                z-index: 1000;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #apply-results {
                margin-top: 20px;
                padding: 10px;
                border: 1px solid #ccc;
                border-radius: 5px;
            }

            .result-item {
                margin-bottom: 10px;
            }

            .success {
                color: green;
            }

            .failure {
                color: red;
            }
        </style>
    </head>

    <body class="py-5">
        <button id="darkModeToggle" class="btn btn-outline-secondary">
            <i class="fas fa-moon"></i>
        </button>

        <div class="container">
            <h1 class="display-4 text-center mb-4">CodePlz</h1>
            <p class="text-center server-path mb-4">
                <i class="fas fa-folder-open me-2"></i>{{ code_path }}
                <span class="ms-3"><i class="fas fa-robot me-2"></i>{{ model_name }}</span>
            </p>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Code Change Request</h5>
                </div>
                <div class="card-body">
                    <div id="userRequestSection">
                        <label for="userRequest" class="form-label">How would you like to change your code?</label>
                        <textarea id="userRequest" class="form-control mb-3"
                            placeholder="e.g., Refactor main function for better performance"></textarea>
                        <div class="d-flex justify-content-end">
                            <button id="submitRequest" class="btn btn-primary">
                                <i class="fas fa-arrow-right me-2"></i>Generate Code Changes
                            </button>
                        </div>
                    </div>

                    <div id="processingSection" class="mt-4 d-none">
                        <h6 class="text-primary mb-2">AI is working on your code...</h6>
                    </div>
                </div>
            </div>

            <div id="resultsSection" class="card d-none">
                <div class="card-header">
                    <h5 class="mb-0">AI-Generated Code Changes</h5>
                </div>
                <div class="card-body">
                    <div id="tokenCount" class="token-count mb-3"></div>
                    <div id="fileList">
                        <!-- File items will be dynamically added here -->
                    </div>
                    <div class="action-buttons">
                        <button id="acceptAllChanges" class="btn btn-success">
                            <i class="fas fa-check-double me-2"></i>Accept All Changes
                        </button>
                        <button id="applyAcceptedChanges" class="btn btn-primary" disabled>
                            <i class="fas fa-sync-alt me-2"></i>Apply Accepted Changes
                        </button>
                    </div>
                </div>
            </div>

            <div id="apply-results" class="card mt-4 d-none">
                <div class="card-header">
                    <h5 class="mb-0">Applied Changes</h5>
                </div>
                <div class="card-body" id="apply-results-content">
                    <!-- Results will be dynamically added here -->
                </div>
            </div>

            <button id="resetButton" class="btn btn-secondary mt-3">
                <i class="fas fa-undo me-2"></i>Reset
            </button>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
        <script>
            const userRequestSection = document.getElementById('userRequestSection');
            const processingSection = document.getElementById('processingSection');
            const resultsSection = document.getElementById('resultsSection');
            const submitButton = document.getElementById('submitRequest');
            const fileList = document.getElementById('fileList');
            const acceptAllChangesButton = document.getElementById('acceptAllChanges');
            const tokenCountElement = document.getElementById('tokenCount');
            const applyAcceptedChangesButton = document.getElementById('applyAcceptedChanges');
            const resetButton = document.getElementById('resetButton');
            const applyResults = document.getElementById('apply-results');
            const applyResultsContent = document.getElementById('apply-results-content');

            submitButton.addEventListener('click', startProcessing);
            acceptAllChangesButton.addEventListener('click', acceptAllChanges);
            resetButton.addEventListener('click', resetAll);
            applyAcceptedChangesButton.addEventListener('click', applyAcceptedChanges);

            let acceptedChangesCount = 0;
            let responseData = null;

            function startProcessing() {
                const userRequest = document.getElementById('userRequest').value;

                processingSection.classList.remove('d-none');
                resultsSection.classList.add('d-none');
                fileList.innerHTML = '';
                applyResults.classList.add('d-none');
                applyResultsContent.innerHTML = '';

                acceptAllChangesButton.classList.remove('btn-outline-success');
                acceptAllChangesButton.classList.add('btn-success');
                acceptAllChangesButton.innerHTML = '<i class="fas fa-check-double me-2"></i>Accept All Changes';
                acceptAllChangesButton.disabled = false;

                acceptedChangesCount = 0;
                acceptAllChangesButton.classList.remove('btn-outline-success');
                acceptAllChangesButton.classList.add('btn-success');
                acceptAllChangesButton.innerHTML = '<i class="fas fa-check-double me-2"></i>Accept All Changes';
                acceptAllChangesButton.disabled = false;
                applyAcceptedChangesButton.disabled = true;
                responseData = null; // Reset responseData

                sendPromptRequest(userRequest);
            }

            function sendPromptRequest(prompt) {
                fetch('/prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: prompt }),
                })
                    .then(response => response.json())
                    .then(data => {
                        responseData = data; // Set the responseData variable
                        showResults(data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while processing your request.');
                        processingSection.classList.add('d-none');
                    });
            }

            function showResults(responseData) {
                processingSection.classList.add('d-none');
                resultsSection.classList.remove('d-none');

                // Display processed files and their token counts
                let processedFilesHtml = '<h6>Processed Files:</h6><ul class="list-group mb-3">';
                responseData.processed_files.forEach(file => {
                    processedFilesHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${file.name}
                            <span class="badge bg-primary rounded-pill">${file.token_count} tokens</span>
                        </li>`;
                });
                processedFilesHtml += '</ul>';

                // Display token counts
                tokenCountElement.innerHTML = `
                    ${processedFilesHtml}
                    <div class="alert alert-info">
                        <div><strong>Input tokens:</strong> ${responseData.input_token_count}</div>
                        <div><strong>Output tokens:</strong> ${responseData.output_token_count}</div>
                    </div>
                `;

                // Display explanation
                const explanationElement = document.createElement('div');
                explanationElement.className = 'alert alert-secondary mb-3';
                explanationElement.innerHTML = `<h5 class="alert-heading">Explanation:</h5><p>${responseData.explanation}</p>`;
                fileList.appendChild(explanationElement);

                // Display changes
                responseData.changes.forEach((changeWithDiff, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item card mb-3';

                    console.log(changeWithDiff);

                    const change = changeWithDiff.change || changeWithDiff; // Handle both structures
                    let actionClass, actionText;
                    switch (change.command) {
                        case 'INSERT_AFTER':
                        case 'INSERT_BEFORE':
                            actionClass = 'text-success';
                            actionText = 'Insert';
                            break;
                        case 'DELETE':
                            actionClass = 'text-danger';
                            actionText = 'Delete';
                            break;
                        case 'CREATE_FILE':
                            actionClass = 'text-primary';
                            actionText = 'Create File';
                            break;
                        case 'RENAME_FILE':
                            actionClass = 'text-warning';
                            actionText = 'Rename File';
                            break;
                        case 'DELETE_FILE':
                            actionClass = 'text-danger';
                            actionText = 'Delete File';
                            break;
                        default:
                            actionClass = 'text-info';
                            actionText = 'Change';
                    }

                    fileItem.innerHTML = `
                        <div class="card-body">
                            <div class="file-header">
                                <h5 class="card-title">${change.filename}</h5>
                                <button class="btn btn-outline-success btn-sm accept-change-btn" data-file-index="${index}">
                                    <i class="fas fa-check me-1"></i>Accept
                                </button>
                            </div>
                            <h6 class="card-subtitle mb-2 ${actionClass}">${actionText}</h6>
                            <p class="card-text"><strong>Reason:</strong> ${change.reason}</p>
                            <button class="btn btn-outline-primary btn-sm mt-2 show-diff-btn">Show Changes</button>
                            <div class="diff-view d-none"></div>
                        </div>
                    `;

                    const showDiffBtn = fileItem.querySelector('.show-diff-btn');
                    const diffView = fileItem.querySelector('.diff-view');
                    const acceptChangeBtn = fileItem.querySelector('.accept-change-btn');

                    showDiffBtn.addEventListener('click', () => {
                        if (diffView.classList.contains('d-none')) {
                            diffView.classList.remove('d-none');
                            showDiffBtn.textContent = 'Hide Changes';
                            diffView.innerHTML = formatDiff(changeWithDiff.diff);
                        } else {
                            diffView.classList.add('d-none');
                            showDiffBtn.textContent = 'Show Changes';
                        }
                    });

                    acceptChangeBtn.addEventListener('click', (event) => {
                        toggleAcceptChange(event.target);
                    });

                    fileList.appendChild(fileItem);
                });

                // Display conclusion
                const conclusionElement = document.createElement('div');
                conclusionElement.className = 'alert alert-secondary mt-3';
                conclusionElement.innerHTML = `<h5 class="alert-heading">Conclusion:</h5><p>${responseData.conclusion}</p>`;
                fileList.appendChild(conclusionElement);
            }

            function formatDiff(diff) {
                return diff.split('\n').map(line => {
                    if (line.startsWith('+')) {
                        return `<div class="diff-added">${escapeHtml(line)}</div>`;
                    } else if (line.startsWith('-')) {
                        return `<div class="diff-removed">${escapeHtml(line)}</div>`;
                    } else {
                        return `<div class="diff-context">${escapeHtml(line)}</div>`;
                    }
                }).join('');
            }

            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function toggleAcceptChange(button) {
                if (button.classList.contains('btn-success')) {
                    // Unaccept the change
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-success');
                    button.innerHTML = '<i class="fas fa-check me-1"></i>Accept';
                    acceptedChangesCount--;
                } else {
                    // Accept the change
                    button.classList.remove('btn-outline-success');
                    button.classList.add('btn-success');
                    button.innerHTML = '<i class="fas fa-check me-1"></i>Accepted';
                    acceptedChangesCount++;
                }

                // Update the Apply Accepted Changes button state
                applyAcceptedChangesButton.disabled = acceptedChangesCount === 0;

                // Update Accept All Changes button state
                const totalChanges = document.querySelectorAll('.accept-change-btn').length;
                if (acceptedChangesCount === totalChanges) {
                    acceptAllChangesButton.classList.remove('btn-success');
                    acceptAllChangesButton.classList.add('btn-outline-success');
                    acceptAllChangesButton.innerHTML = '<i class="fas fa-check-double me-2"></i>All Changes Accepted';
                    acceptAllChangesButton.disabled = true;
                } else {
                    acceptAllChangesButton.classList.remove('btn-outline-success');
                    acceptAllChangesButton.classList.add('btn-success');
                    acceptAllChangesButton.innerHTML = '<i class="fas fa-check-double me-2"></i>Accept All Changes';
                    acceptAllChangesButton.disabled = false;
                }
            }

            function acceptAllChanges() {
                document.querySelectorAll('.accept-change-btn').forEach(button => {
                    if (!button.classList.contains('btn-success')) {
                        toggleAcceptChange(button);
                    }
                });
            }

            function applyAcceptedChanges() {
                console.log(responseData);
                const changes = Array.from(document.querySelectorAll('.accept-change-btn.btn-success'))
                    .map(button => {
                        const index = parseInt(button.getAttribute('data-file-index'));
                        return responseData.changes[index].change || responseData.changes[index];
                    })
                    .filter(change => change && change.command); // Filter out null or invalid changes

                if (changes.length > 0) {
                    console.log('Changes to be applied:', changes);
                    fetch('/apply_changes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ changes: changes })
                    })
                        .then(response => response.json())
                        .then(data => {
                            let resultsHtml = data.results.map(result => `
                                <div class="alert ${result.success ? 'alert-success' : 'alert-danger'} mb-2">
                                    <strong>${result.filename}:</strong> ${result.message}
                                </div>
                            `).join('');

                            const applyResultsContent = document.getElementById('apply-results-content');
                            applyResultsContent.innerHTML = resultsHtml;

                            const applyResults = document.getElementById('apply-results');
                            applyResults.classList.remove('d-none');
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            const applyResultsContent = document.getElementById('apply-results-content');
                            applyResultsContent.innerHTML = `
                                <div class="alert alert-danger">
                                    <h5 class="alert-heading">Error</h5>
                                    <p>An error occurred while applying changes.</p>
                                </div>`;

                            const applyResults = document.getElementById('apply-results');
                            applyResults.classList.remove('d-none');
                        });
                } else {
                    console.log('No valid changes to apply');
                    const applyResultsContent = document.getElementById('apply-results-content');
                    applyResultsContent.innerHTML = `
                        <div class="alert alert-warning">
                            <h5 class="alert-heading">No Changes Applied</h5>
                            <p>No valid changes to apply.</p>
                        </div>`;

                    const applyResults = document.getElementById('apply-results');
                    applyResults.classList.remove('d-none');
                }
            }

            function resetAll() {
                userRequestSection.classList.remove('d-none');
                processingSection.classList.add('d-none');
                resultsSection.classList.add('d-none');
                document.getElementById('userRequest').value = '';
                fileList.innerHTML = '';
                acceptAllChangesButton.classList.remove('btn-outline-success');
                acceptAllChangesButton.classList.add('btn-success');
                acceptAllChangesButton.innerHTML = '<i class="fas fa-check-double me-2"></i>Accept All Changes';
                acceptAllChangesButton.disabled = false;
                applyAcceptedChangesButton.disabled = true;
                applyAcceptedChangesButton.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Apply Accepted Changes';
                acceptedChangesCount = 0;
                applyResults.classList.add('d-none');
                applyResultsContent.innerHTML = '';
                responseData = null; // Reset responseData
            }

            const darkModeToggle = document.getElementById('darkModeToggle');
            darkModeToggle.addEventListener('click', toggleDarkMode);

            function toggleDarkMode() {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                darkModeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';

                // Update button styles
                if (isDarkMode) {
                    darkModeToggle.classList.remove('btn-outline-secondary');
                    darkModeToggle.classList.add('btn-outline-light');
                    submitButton.classList.remove('btn-primary');
                    submitButton.classList.add('btn-light');
                } else {
                    darkModeToggle.classList.remove('btn-outline-light');
                    darkModeToggle.classList.add('btn-outline-secondary');
                    submitButton.classList.remove('btn-light');
                    submitButton.classList.add('btn-primary');
                }

                // Save preference to localStorage
                localStorage.setItem('darkMode', isDarkMode);
            }

            // Check for saved dark mode preference
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                toggleDarkMode();
            }

            // Add this function to count the lines
            function countLines(diff, prefix) {
                return diff.split('\n').filter(line => line.startsWith(prefix)).length;
            }
        </script>
    </body>

</html>